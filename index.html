<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>날씨 및 버스 정보</title>
    <link rel="stylesheet" href="./style.css">
    <link href="/website/css/uicons-bold-rounded.css">
    <script type="text/javascript" src="main.js"></script>
    <script type="text/javascript" src="api_keys.js"></script>

</head>

<body>
    <div class="container">
        <div class="header">

            <div id="weather-info" style="text-align: left;">
                <h2 id="weather-header">
                    오늘의 날씨
                </h2><img id="weather_icon">
                <br>
                <p id="city_Name"></p>
                <p id="city_weather"></p>
                <p id="city_temperature"></p>
                <p id="city_humanity"></p>
            </div>
            <p></p>
            <div class="date-time">
                <h2>
                    현재 시간
                </h2>
                <br>
                <p id="currenttime"></p>
                <p id="currentdate"></p>
            </div>
        </div>
        <div class="bus-info" style="text-align: left;">
            <h2>
                < BUS >
            </h2>
            <br>
            <p style="text-align: right;"><span>현재위치: 수일중학교</span></p>
            <br>
            <div id="bus_route">

            </div>
            <!-- <p id="1st_bus">102번 도착예정시간: 12분, 10정거장 전</p>
            <p id="2nd_bus">103번 도착예정시간: 2분, 2정거장 전</p>
            <p id="3rd_bus">311번 도착예정시간: 1분, 1정거장 전</p> -->
        </div>
        <p></p>
        <div class="recommend">
            <br>
            <h3>오늘의 옷 추천</h3>
            <p id="cloth"></p>
            <br>
        </div>

        <div class="footer">
            <a href="#"><img src="./resource/front-of-bus.png" alt="알람"></a>
            <a href="#"><img src="./resource/location-pin.png" alt="버스"></a>
            <a href="#"><img src="./resource/hamburger.png" alt="메뉴"></a>
            <a href="#"><img src="./resource/setting.png" alt="설정"></a>
        </div>
    </div>
    <script type="importmap">
        {
          "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
          }
        }
      </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        const genAI = new GoogleGenerativeAI(config.jemini_API);

        async function run() {
            // For text-only input, use the gemini-pro model
            const model = genAI.getGenerativeModel({ model: "gemini-pro" });

            const prompt = `Please give short advice on how to wear clothes considering the season, weather, temperature and humidity. In 10 words. The current temperature is :${tempperature},The weather is: ${weatherDescription}`

            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            document.getElementById('cloth').innerHTML = text
        }

        run();
    </script>

    <script>
        /////////////////// updateTime() 함수 정의////////////////////////////////
        ////////////////////////////////현재 시간 정의 ////////////////////////////
        function updateTime() {
            const now = new Date(); // 현재 시간을 가져옴
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const currentTime = `${hours}:${minutes}:${seconds}`;
            document.getElementById('currenttime').innerHTML = `<h1>${currentTime}</h1>`;

            const options = {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            };
            const currentDate = now.toLocaleDateString('ko-KR', options);
            document.getElementById('currentdate').innerHTML = currentDate;
        }

        setInterval(updateTime, 1000);

        ////////////////////////////////////////////////////////////////////
        ////////////////////// 버스 api /////////////////////////////////// 

        function getBusInformation() {
            var xhr = new XMLHttpRequest();
            var url = 'http://apis.data.go.kr/6410000/busarrivalservice/getBusArrivalList'; /*URL*/
            var queryParams = '?' + encodeURIComponent('serviceKey') + '=' + config.bus_API; /*Service Key*/
            queryParams += '&' + encodeURIComponent('stationId') + '=' + encodeURIComponent('200000078'); /**/
            xhr.open('GET', url + queryParams);
            xhr.onreadystatechange = function () {
                if (this.readyState == 4) {
                    // XML 문자열을 파싱하여 DOM 객체로 변환
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xmlString, "text/xml");

                    // busArrivalList 요소들을 가져옴
                    var busArrivalLists = xmlDoc.getElementsByTagName("busArrivalList");

                    // JSON 객체로 변환할 배열 생성
                    var jsonData = [];

                    // 각 busArrivalList에 대해 반복하여 데이터를 추출하여 JSON 객체로 변환 후 배열에 추가
                    for (var i = 0; i < 4; i++) {
                        var busArrivalList = busArrivalLists[i];

                        // 필요한 정보를 가져옴
                        var routeId = busArrivalList.getElementsByTagName("routeId")[0].textContent;
                        var locationNo1 = busArrivalList.getElementsByTagName("locationNo1")[0].textContent;
                        var preddictTime1 = busArrivalList.getElementsByTagName("predictTime1")[0].textContent;

                        // JSON 객체로 변환하여 배열에 추가
                        var jsonDataItem = {
                            "routeId": routeId,
                            "preddictTime1" : preddictTime1,
                            "locationNo1": locationNo1
                        };
            //              <p id="1st_bus">102번 도착예정시간: 12분, 10정거장 전</p>
            //              <p id="2nd_bus">103번 도착예정시간: 2분, 2정거장 전</p>
            //              <p id="3rd_bus">311번 도착예정시간: 1분, 1정거장 전</p>
                        jsonData.push(jsonDataItem);
                        document.getElementById("bus_route").innerHTML += `<p>${routeId}번 도착 예정 시간 : ${preddictTime1}분, ${locationNo1}정거장 전 </p>`
                    }

                    // JSON 문자열로 변환하여 출력
                    console.log(JSON.stringify(jsonData));


                }

            };

            xhr.send('');
        }

        getBusInformation()
        setInterval(getBusInformation, 1000 * 60)

        /////////////////////////////////////////////////////////////////////
        /////////////////////////// 날씨 api ////////////////////////////////
        //////////////////////////////////////////////////////////////////////
        var weatherDescription;
        var tempperature;
        var humidity;

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var lat = position.coords.latitude; // 위도
                    var lng = position.coords.longitude; // 경도


                    var apiKey = config.openWeather_API;
                    var apiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${apiKey}`;

                    fetch(apiUrl)
                        .then(response => response.json())
                        .then((data) => {

                            var cityName = data.name;
                            var weather_icon = data.weather[0].icon
                            weatherDescription = data.weather[0].description;
                            tempperature = data.main.temp;
                            humidity = data.main.humidity;

                            document.getElementById('city_Name').innerHTML = `도시 : ${cityName}`
                            document.getElementById('city_weather').innerHTML = `날씨 : ${weatherDescription}`
                            document.getElementById('city_temperature').innerHTML = `온도 : ${tempperature.toFixed(1)} °C`
                            document.getElementById('city_humanity').innerHTML = `습도 : ${humidity}%`
                            document.getElementById('weather_icon').src = `https://openweathermap.org/img/wn/${weather_icon}@2x.png`
                        })
                        .catch(() => {
                            console.log("날씨 정보를 가져오는 중 오류 발생 : ", error);
                            document.getElementById('weather-info').innerHTML = "날씨 정보를 가져올 수 없습니다.";
                        })
                })
            }
        }

        getLocation();
        setInterval(getLocation(), 1000 * 3600);


    </script>

    <script>
        /// api key 받기
        import config from "./api_keys.js";
    </script>
</body>

</html>